<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Óptica Yolanda — 3 Sucursales</title>
<link rel="icon" href="img/logo_optica_yolanda.png" />
<style>
:root{
  --rojo:#8b0000; --negro:#000; --blanco:#fff; --gris:#ccc;
  --oro:#ffd700; --oro1:#fff2a6; --oro2:#ffd34d; --oro3:#caa231; --oro4:#8f6b00;
  --green:#22c55e; --orange:#f59e0b; --red:#ef4444; --danger:#ff4040;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Poppins",system-ui,Segoe UI,Roboto,Ubuntu,Arial;
  background:
    linear-gradient(180deg,var(--rojo),var(--negro)),
    url("https://www.transparenttextures.com/patterns/dark-leather.png");
  background-blend-mode:overlay; background-size:cover; color:var(--blanco);
}
.container{max-width:1100px;margin:0 auto;padding:16px}

/* Header boutique */
header{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:25px 0 10px;text-align:center;border-bottom:1px solid rgba(255,255,255,.18)}
header img{
  width:150px;height:auto;margin-bottom:10px;border-radius:12px;position:relative;overflow:hidden;
  box-shadow:0 4px 20px rgba(0,0,0,.4);transition: transform .4s ease, box-shadow .4s ease;
}
header img:hover{transform:scale(1.03);box-shadow:0 6px 25px rgba(255,215,0,.4)}
header img::after{
  content:""; position:absolute; top:-120%; left:-75%; width:50%; height:300%;
  background:linear-gradient(120deg, rgba(255,255,255,.05), rgba(255,255,255,.3) 50%, rgba(255,255,255,.05));
  transform:skewX(-25deg); animation:shineMove 6s ease-in-out infinite; pointer-events:none; border-radius:inherit;
}
@keyframes shineMove{0%{top:-120%;left:-75%}50%{top:-50%;left:100%}100%{top:120%;left:200%}}
header h1{
  margin:0;font-size:28px;letter-spacing:1px;font-weight:700;
  background:linear-gradient(135deg,var(--oro1),var(--oro2) 30%,var(--oro3) 55%,var(--oro1) 70%,var(--oro4) 100%);
  -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;text-fill-color:transparent;
  background-size:200% 100%; animation:goldSparkle 6s linear infinite; text-shadow:0 1px 1px rgba(0,0,0,.35);
}
@keyframes goldSparkle{0%{background-position:0% 0}100%{background-position:200% 0}}
.subtitle{font-size:14px;color:var(--gris)}
.top-actions{margin-top:8px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.badge{display:none;background:#14b814;color:#000;padding:6px 10px;border-radius:999px;font-weight:700}

/* Tabs sucursales */
.tabs{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;margin:16px 0}
.tab{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.25);padding:8px 14px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .2s}
.tab:hover{background:rgba(255,255,255,.25)}
.tab.active{background:linear-gradient(135deg,var(--oro1),var(--oro2) 40%,var(--oro3));color:#201a00;border-color:rgba(255,255,255,.6);box-shadow:0 0 0 1px rgba(255,255,255,.35) inset,0 6px 18px rgba(255,215,0,.25)}

/* Layout & Cards */
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
@media (max-width:960px){.grid{grid-template-columns:1fr}}
.card{
  background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.25);border-radius:16px;padding:18px;margin-bottom:18px;
  box-shadow:0 10px 28px rgba(0,0,0,.55),0 0 0 1px rgba(255,255,255,.06) inset;backdrop-filter:blur(6px)
}
.card h3{margin:0 0 10px}
.muted{color:var(--gris)}
.info{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:720px){.info{grid-template-columns:1fr}}

/* Botones */
.btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,var(--oro2),var(--oro3));color:#201a00;font-weight:700;border:1px solid rgba(255,255,255,.65);border-radius:10px;padding:10px 14px;text-decoration:none;cursor:pointer;transition:all .2s}
.btn:hover{filter:brightness(1.05);box-shadow:0 10px 26px rgba(255,215,0,.35)}

/* Categorías */
.category-tabs{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;margin:10px 0 14px}
.cat-tab{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.25);border-radius:8px;padding:8px 14px;cursor:pointer;transition:all .2s}
.cat-tab:hover{background:rgba(255,255,255,.25)}
.cat-tab.active{background:var(--oro2);color:#000;border-color:var(--oro2)}

/* Productos */
.products{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:960px){.products{grid-template-columns:repeat(2,1fr)}}
@media (max-width:560px){.products{grid-template-columns:1fr}}
.product{position:relative;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);border-radius:12px;overflow:hidden;transition:transform .2s,box-shadow .2s}
.product:hover{transform:translateY(-3px);box-shadow:0 5px 20px rgba(255,215,0,.25)}
.product img{width:100%;height:160px;object-fit:cover;display:block}
.product .pbd{padding:12px}
.code{font-size:12px;opacity:.8;margin-bottom:3px}
.price{color:var(--oro2);font-weight:800;margin-top:4px;text-shadow:0 1px 0 rgba(0,0,0,.35)}
.price-old{opacity:.7;text-decoration:line-through;margin-right:6px}
.badge-offer{position:absolute;top:8px;left:8px;background:var(--danger);color:#fff;padding:4px 8px;border-radius:8px;font-size:12px;font-weight:800;box-shadow:0 2px 8px rgba(0,0,0,.35)}
.badge-discount{position:absolute;top:8px;right:8px;color:#08210f;font-weight:900;font-size:12px;padding:4px 8px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.35)}
.badge-discount.disc-10{background:var(--green)}
.badge-discount.disc-20{background:var(--orange)}
.badge-discount.disc-30{background:var(--red)}
.actions-admin{position:absolute;top:8px;right:8px;display:none;gap:6px}
.actions-admin .small{font-size:12px;padding:6px 8px;border-radius:8px}

/* Favoritos */
.fav-btn{
  position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.35);
  color:#fff;border-radius:999px;padding:6px 9px;cursor:pointer;font-weight:800
}
.fav-btn.active{background:#ff4d7e;border-color:#ff4d7e}
.fav-tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;margin:8px 0 6px}
.fav-counter{background:#ff4d7e;color:#fff;border-radius:999px;padding:6px 10px;font-weight:800}

/* Section headers in "Todos" */
.cat-header{
  margin:14px 4px 8px;
  font-weight:800;
  letter-spacing:.2px;
  color:#ffd34d;
  text-shadow:0 1px 0 rgba(0,0,0,.45);
  border-left:4px solid rgba(255,211,77,.8);
  padding-left:10px;
}

/* Footer */
footer{margin:26px 0 8px;color:#ddd;font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}

/* Modales */
#adminModal,#editModal,#vendorModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center;padding:16px}
.modal-card{background:#111;border:1px solid rgba(255,255,255,.25);border-radius:14px;max-width:420px;width:100%;padding:18px;color:#fff}
.vendor-list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
.vendor-btn{display:flex;justify-content:space-between;align-items:center;gap:10px;background:#1a1a1a;border:1px solid rgba(255,255,255,.25);border-radius:10px;padding:10px 12px;cursor:pointer}
.vendor-btn:hover{filter:brightness(1.05)}
.vendor-phone{opacity:.8;font-size:12px}
</style>
</head>
<body>
<div class="container">
  <header>
    <img src="img/logo_optica_yolanda.png" alt="Óptica Yolanda" />
    <h1>Óptica Yolanda</h1>
    <div class="subtitle">Elige la sucursal y mira dirección, horarios, WhatsApp y catálogo.</div>

    <div class="top-actions">
      <button id="adminBtn" class="btn" type="button">Administrador</button>
      <span id="adminBadge" class="badge">Admin activo</span>
    </div>

    <!-- Modal Admin -->
    <div id="adminModal">
      <div class="modal-card">
        <h3 style="margin:0 0 8px">Ingreso administrador</h3>
        <p style="opacity:.8;margin-top:0">Contraseña para habilitar edición/carga.</p>
        <input id="adminPass" type="password" placeholder="Contraseña"/>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
          <button id="adminCancel" class="btn" type="button">Cancelar</button>
          <button id="adminOk" class="btn" type="button">Ingresar</button>
        </div>
        <div id="adminError" style="color:#ffb3b3;margin-top:10px;display:none">Contraseña incorrecta</div>
      </div>
    </div>

    <!-- Modal Editar -->
    <div id="editModal">
      <div class="modal-card">
        <h3 style="margin:0 0 8px">Editar producto</h3>
        <input id="editCode" placeholder="Código"/>
        <input id="editName" placeholder="Nombre"/>
        <input id="editPrice" placeholder="Precio"/>
        <select id="editCat">
          <option value="dama">Dama</option>
          <option value="caballero">Caballero</option>
          <option value="clipon_dama">Clipon Dama</option>
          <option value="clipon_caballero">Clipon Caballero</option>
          <option value="ninos">Niños</option>
          <option value="solares">Lentes de sol</option>
        </select>
        <div class="row" style="margin-top:6px">
          <label style="display:flex;align-items:center;gap:8px;background:transparent;border:none;padding:0">
            <input type="checkbox" id="editOffer" /> Marcar como oferta
          </label>
          <input id="editPromo" placeholder="Precio promo (si es oferta)" style="max-width:180px"/>
        </div>
        <div class="muted" style="font-size:12px">Si no seleccionas imagen, se mantiene la actual.</div>
        <input type="file" id="editImage" accept="image/*" />
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
          <button id="editCancel" class="btn" type="button">Cancelar</button>
          <button id="editSave" class="btn" type="button">Guardar cambios</button>
        </div>
      </div>
    </div>

    <!-- Modal Selección de Vendedora -->
    <div id="vendorModal">
      <div class="modal-card">
        <h3 style="margin:0 0 8px">Elegí la vendedora</h3>
        <p class="muted" style="margin:0 0 10px">Se enviará por WhatsApp.</p>
        <div id="vendorList" class="vendor-list"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
          <button id="vendorCancel" class="btn" type="button">Cancelar</button>
        </div>
      </div>
    </div>
  </header>

  <div class="tabs" id="tabs"></div>

  <div class="grid">
    <div class="card">
      <h3 id="branchTitle">Sucursal</h3>
      <div class="info">
        <div>
          <p class="muted"><strong>Dirección: </strong><span id="addr">—</span></p>
          <p class="muted"><strong>Horarios: </strong><span id="hours">—</span></p>
          <div class="actions">
            <button class="btn" id="wapp" type="button">WhatsApp</button>
          </div>
        </div>
        <div style="min-height:200px">
          <div id="mapEmbed" style="height:200px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;color:#eee;font-size:13px;background:rgba(255,255,255,.05)">Mapa (opcional)</div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,.2);margin:16px 0"/>
      <h3>Catálogo por categoría</h3>

      <div class="category-tabs" id="catTabs">
        <button class="cat-tab active" data-cat="todos">Todos</button>
        <button class="cat-tab" data-cat="dama">Dama</button>
        <button class="cat-tab" data-cat="caballero">Caballero</button>
        <button class="cat-tab" data-cat="clipon_dama">Clipon Dama</button>
        <button class="cat-tab" data-cat="clipon_caballero">Clipon Caballero</button>
        <button class="cat-tab" data-cat="ninos">Niños</button>
        <button class="cat-tab" data-cat="solares">Lentes de sol</button>
        <button class="cat-tab" data-cat="ofertas">Ofertas</button>
        <button class="cat-tab" data-cat="favoritos">Favoritos ❤️</button>
      </div>

      <!-- Búsqueda / Favoritos -->
      <div class="fav-tools">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="searchCode" placeholder="Buscar por código..." style="max-width:220px" />
          <button id="clearSearch" class="btn" type="button">Limpiar</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span id="favCounter" class="fav-counter">0 favoritos</span>
          <button id="copyFav" class="btn" type="button">Copiar portapapeles</button>
          <button id="sendFav" class="btn" type="button">Enviar favoritos por WhatsApp</button>
        </div>
      </div>

      <div class="products" id="products"></div>

      <div class="form-upload" id="uploadBlock">
        <h4>Agregar producto</h4>
        <div class="row">
          <select id="prodCat">
            <option value="dama">Dama</option>
            <option value="caballero">Caballero</option>
            <option value="clipon_dama">Clipon Dama</option>
            <option value="clipon_caballero">Clipon Caballero</option>
            <option value="ninos">Niños</option>
            <option value="solares">Lentes de sol</option>
          </select>
          <label style="display:flex;align-items:center;gap:8px;background:transparent;border:none">
            <input type="checkbox" id="prodOffer" /> Oferta
          </label>
          <input type="text" id="prodPromo" placeholder="Precio promo (si oferta)" style="max-width:180px"/>
        </div>
        <input type="text"  id="prodCode"  placeholder="Código (obligatorio)" />
        <input type="text"  id="prodName"  placeholder="Nombre del producto" />
        <input type="text"  id="prodPrice" placeholder="Precio (ej: ₲ 250.000)" />
        <input type="file"  id="prodImage" accept="image/*" />
        <button id="uploadBtn">Cargar producto a esta sucursal</button>
        <div class="muted" style="font-size:12px">Las imágenes se guardan en el servidor y quedarán visibles para esta sucursal.</div>
      </div>
    </div>

    <div class="card">
      <h3>Sobre Óptica Yolanda</h3>
      <p class="muted">Especialistas en lentes, armazones y contacto. Examen visual y entrega rápida. Calidad al mejor precio.</p>
    </div>
  </div>

 <footer>
  <div style="text-align:center;width:100%;font-weight:600;color:#fff;">
    ÓPTICA YOLANDA – PY
  </div>
</footer>

</div>

<script>
// ===== Datos de sucursales con vendedoras y mapQuery
const BRANCHES = [
  {
    id:'central',
    nombre:'Óptica Yolanda Central',
    direccion:'Azara 1167 casi Brasil',
    horarios:'08:00 a 18:00',
    mapQuery:'Federación de Químicos del Paraguay, Azara 1175, Asunción 001220',
    vendors:[
      { name:'Dahiana', phone:'+595986315354' },
      { name:'Belén',   phone:'+595991675556' }

    ]
  },
  {
    id:'fernando',
    nombre:'Óptica Yolanda Fernando de la Mora',
    direccion:'Ruta Mcal. José Estigarribia esquina 15 de Mayo',
    horarios:'08:00 a 18:00',
    mapQuery:'Ruta Mariscal José Felix Estigarribia, Fernando de la Mora',
    vendors:[
      { name:'Gabriela', phone:'+595983989860' },
      { name:'Naida',    phone:'+595976512219' }
    ]
  },
  {
    id:'caacupe',
    nombre:'Óptica Yolanda Caacupé',
    direccion:'Ruta del Maestro 1807 esquina Independencia Nacional',
    horarios:'08:00 a 18:00',
    mapQuery:'Caacupé 030102',
    vendors:[
      { name:'Celeste', phone:'+595972760646' }
    ]
  }
];

const CATS = ["dama","caballero","clipon_dama","clipon_caballero","ninos","solares"];
const CAT_LABEL = {
  dama: "Dama",
  caballero: "Caballero",
  clipon_dama: "Clipon Dama",
  clipon_caballero: "Clipon Caballero",
  ninos: "Niños",
  solares: "Lentes de sol",
  ofertas: "Ofertas",
  favoritos: "Favoritos",
  todos: "Todos"
};

// ===== Referencias UI
const tabsEl = document.getElementById('tabs');
const productsEl = document.getElementById('products');
const branchTitle = document.getElementById('branchTitle');
const addr = document.getElementById('addr');
const hours = document.getElementById('hours');
const wappBtn = document.getElementById('wapp');
const uploadBlock = document.getElementById('uploadBlock');

const searchCode = document.getElementById('searchCode');
const clearSearch = document.getElementById('clearSearch');

const favCounter = document.getElementById('favCounter');
const copyFav = document.getElementById('copyFav');
const sendFav = document.getElementById('sendFav');

let current = BRANCHES[0].id;
let currentCat = 'todos';
let productosCache = [];

// ===== Admin
const adminBtn = document.getElementById('adminBtn');
const adminBadge = document.getElementById('adminBadge');
const adminModal = document.getElementById('adminModal');
const adminOk = document.getElementById('adminOk');
const adminCancel = document.getElementById('adminCancel');
const adminPass = document.getElementById('adminPass');

function isAdmin(){ return localStorage.getItem('oy_admin') === '1'; }
function setAdmin(v){ if(v){localStorage.setItem('oy_admin','1')} else {localStorage.removeItem('oy_admin')} refreshAdminUI(); }
function refreshAdminUI(){
  const on = isAdmin();
  uploadBlock.style.display = on ? 'block' : 'none';
  adminBadge.style.display = on ? 'inline-flex' : 'none';
  adminBtn.textContent = on ? 'Salir de administrador' : 'Administrador';
  document.querySelectorAll('.actions-admin').forEach(x=> x.style.display = on ? 'flex' : 'none');
}
function adminHeader(){ return { 'x-admin-key': localStorage.getItem('oy_admin_key') || '' }; }

adminBtn.addEventListener('click', ()=>{
  if(isAdmin()){ setAdmin(false); return; }
  adminModal.style.display = 'flex';
  adminPass.value = '';
  setTimeout(()=>adminPass.focus(), 50);
});
adminCancel.addEventListener('click', ()=> adminModal.style.display = 'none');
adminOk.addEventListener('click', ()=>{
  const guess = adminPass.value.trim();
  if(!guess) return;
  localStorage.setItem('oy_admin_key', guess);
  adminModal.style.display = 'none';
  setAdmin(true);
});
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') adminModal.style.display='none'; });

// ===== Tabs sucursales
function renderTabs(){
  tabsEl.innerHTML = '';
  BRANCHES.forEach(b => {
    const btn = document.createElement('button');
    btn.className = 'tab' + (b.id===current?' active':'');
    btn.textContent = b.nombre;
    btn.onclick = () => { current = b.id; renderBranch(); };
    tabsEl.appendChild(btn);
  });
}

// ===== Helpers
async function fetchProductos(){
  try{
    const r = await fetch(`/productos/${current}`);
    if(!r.ok) return {productos:[]};
    return await r.json();
  }catch(e){ return {productos:[]} }
}

function parseGs(val){
  const s = (val ?? '').toString().trim();
  if(!s) return 0;
  const n = s.replace(/[^\d,\.]/g,'').replace(/\./g,'').replace(/,/g,'');
  return Number(n) || 0;
}

function discountPercent(p){
  const base = parseGs(p.precio);
  const promo = parseGs(p.precioPromo);
  if(!p.oferta || !base || !promo || promo >= base) return 0;
  return Math.max(1, Math.round((1 - (promo/base)) * 100));
}

// ===== Favoritos (por sucursal en localStorage)
function favKey(){ return `oy_favs_${current}`; }
function getFavs(){
  try { return JSON.parse(localStorage.getItem(favKey())) || []; }
  catch { return []; }
}
function setFavs(arr){ localStorage.setItem(favKey(), JSON.stringify(arr)); updateFavCounter(); }
function isFav(id){ return getFavs().some(f => f.id === id); }
function toggleFav(p){
  const favs = getFavs();
  const i = favs.findIndex(f => f.id === p.id);
  if(i >= 0) favs.splice(i,1);
  else favs.push({ id:p.id, codigo:p.codigo, nombre:p.nombre, precio:p.precio, precioPromo:p.precioPromo, oferta:p.oferta });
  setFavs(favs);
  renderBranch();
}
function updateFavCounter(){
  const n = getFavs().length;
  favCounter.textContent = `${n} favorito${n===1?'':'s'}`;
}

// ===== Vendor modal
const vendorModal = document.getElementById('vendorModal');
const vendorList  = document.getElementById('vendorList');
const vendorCancel= document.getElementById('vendorCancel');

vendorCancel.onclick = ()=>{ vendorModal.style.display='none'; };

function openVendorPicker(onPick){
  const branch = BRANCHES.find(b=>b.id===current);
  vendorList.innerHTML = '';
  (branch.vendors || []).forEach(v=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'vendor-btn';
    btn.innerHTML = `<span>${v.name}</span><span class="vendor-phone">${v.phone}</span>`;
    btn.onclick = ()=>{
      vendorModal.style.display = 'none';
      const num = (v.phone || '').replace(/\s+/g,'').replace(/^\+/, ''); // sin '+'
      if(onPick) onPick(num);
    };
    vendorList.appendChild(btn);
  });
  vendorModal.style.display = 'flex';
}

// ===== Card de producto
function productCard(p){
  const pct = discountPercent(p);
  const discClass = pct>=30 ? 'disc-30' : (pct>=20 ? 'disc-20' : (pct>=10 ? 'disc-10' : ''));

  const wrap = document.createElement('div');
  wrap.className = 'product';
  wrap.innerHTML = `
    ${p.oferta ? '<div class="badge-offer">OFERTA</div>' : ''}
    ${pct ? `<div class="badge-discount ${discClass}">-${pct}%</div>` : ''}
    <img src="${p.img}" alt="${p.nombre}" loading="lazy"/>
    <div class="actions-admin">
      <button class="btn small edit">Editar</button>
      <button class="btn small delete">Eliminar</button>
    </div>
    <button class="fav-btn ${isFav(p.id)?'active':''}" title="Agregar a favoritos">❤</button>
    <div class="pbd">
      <div class="code">Código: ${p.codigo || '-'}</div>
      <div style="font-weight:700">${p.nombre}</div>
      <div class="price">
        ${p.oferta && p.precioPromo
          ? `<span class="price-old">${p.precio}</span> <span>${p.precioPromo}</span> <span style="font-size:12px;opacity:.9">(-${pct}%)</span>`
          : `${p.precio}`
        }
      </div>
    </div>`;

  wrap.querySelector('.fav-btn').onclick = () => toggleFav(p);

  const act = wrap.querySelector('.actions-admin');
  act.style.display = isAdmin() ? 'flex' : 'none';
  wrap.querySelector('.edit').onclick = () => openEdit(p);
  wrap.querySelector('.delete').onclick = () => delProduct(p);
  return wrap;
}

// ===== Render principal
async function renderBranch(){
  renderTabs();
  const b = BRANCHES.find(x=>x.id===current);
  branchTitle.textContent = b.nombre;
  addr.textContent = b.direccion;
  hours.textContent = b.horarios;

  // Mapa embebido + botones (usa mapQuery)
  const mapDiv = document.getElementById('mapEmbed');
  let q = b.mapQuery ? encodeURIComponent(b.mapQuery) : null;
  if (q) {
    mapDiv.innerHTML = `
      <iframe
        src="https://www.google.com/maps?q=${q}&z=16&output=embed"
        width="100%" height="200" style="border:0" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
      </iframe>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn" href="https://www.google.com/maps/dir/?api=1&destination=${q}" target="_blank" rel="noopener">Cómo llegar</a>
        <a class="btn" href="https://www.google.com/maps/search/?api=1&query=${q}" target="_blank" rel="noopener">Ver en Google Maps</a>
      </div>
    `;
  } else {
    mapDiv.textContent = "Mapa no disponible";
  }

  // Catálogo
  productsEl.innerHTML = '';
  const data = await fetchProductos();
  productosCache = data.productos || [];

  const qSearch = (searchCode.value || '').trim().toLowerCase();

  function renderList(list){
    list
      .filter(p => !qSearch || (p.codigo || '').toLowerCase().includes(qSearch))
      .forEach(p => productsEl.appendChild(productCard(p)));
  }

  if (currentCat === 'todos') {
    const ofertas = productosCache.filter(p => p.oferta);
    if (ofertas.length){
      const h = document.createElement('div');
      h.className = 'cat-header'; h.textContent = "Ofertas";
      productsEl.appendChild(h); renderList(ofertas);
    }
    CATS.forEach(cat => {
      const subset = productosCache.filter(p => (p.categoria || '') === cat);
      if (!subset.length) return;
      const h = document.createElement('div');
      h.className = 'cat-header'; h.textContent = CAT_LABEL[cat] || cat;
      productsEl.appendChild(h); renderList(subset);
    });
  } else if (currentCat === 'ofertas') {
    renderList(productosCache.filter(p => p.oferta));
  } else if (currentCat === 'favoritos') {
    const favs = getFavs().map(f => productosCache.find(p => p.id === f.id)).filter(Boolean);
    renderList(favs);
  } else {
    const subset = productosCache.filter(p => (p.categoria || '') === currentCat);
    renderList(subset);
  }

  refreshAdminUI();
  updateFavCounter();
}

// ===== Eventos UI
document.getElementById('catTabs').addEventListener('click', (e)=>{
  const btn = e.target.closest('.cat-tab');
  if(!btn) return;
  document.querySelectorAll('.cat-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentCat = btn.dataset.cat;
  renderBranch();
});

searchCode.addEventListener('input', ()=> renderBranch());
clearSearch.addEventListener('click', ()=>{ searchCode.value=''; renderBranch(); });

// WhatsApp general → selector de vendedora
wappBtn.addEventListener('click', ()=>{
  openVendorPicker((phone)=>{
    const text = encodeURIComponent("Hola, me interesa este producto");
    window.open(`https://wa.me/${phone}?text=${text}`, '_blank');
  });
});

// Copiar favoritos al portapapeles
copyFav.addEventListener('click', async ()=>{
  const favs = getFavs();
  if(!favs.length){ alert('No hay favoritos. Agrega con el corazón ❤'); return; }
  const single = favs.length === 1;
  const lines = favs.map(f => `• ${f.codigo || '-'} — ${f.nombre || ''}${(f.oferta && f.precioPromo)?` (Promo: ${f.precioPromo})`:''}`);
  const head = single ? 'Hola, me interesa este producto:\n\n' : 'Hola, me interesan estos productos:\n\n';
  const text = head + lines.join('\n');
  try{
    await navigator.clipboard.writeText(text);
    alert('Lista copiada al portapapeles ✅');
  }catch(e){
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); alert('Lista copiada al portapapeles ✅'); }
    catch(err){ alert('No se pudo copiar.'); }
    document.body.removeChild(ta);
  }
});

// Enviar favoritos por WhatsApp → selector de vendedora
sendFav.addEventListener('click', ()=>{
  const favs = getFavs();
  if(!favs.length){ alert('No hay favoritos. Agrega con el corazón ❤'); return; }

  const single = favs.length === 1;
  const lines = favs.map(f => `• ${f.codigo || '-'} — ${f.nombre || ''}${(f.oferta && f.precioPromo)?` (Promo: ${f.precioPromo})`:''}`);
  const head = single ? 'Hola, me interesa este producto:\n\n' : 'Hola, me interesan estos productos:\n\n';
  const text = encodeURIComponent(head + lines.join('\n'));

  openVendorPicker((phone)=>{
    window.open(`https://wa.me/${phone}?text=${text}`, '_blank');
  });
});

// ===== Alta
document.getElementById('uploadBtn').addEventListener('click', async ()=>{
  if(!isAdmin()){ alert('Solo el administrador puede cargar productos'); return; }

  const name = document.getElementById('prodName').value.trim();
  const price = document.getElementById('prodPrice').value.trim();
  const code  = document.getElementById('prodCode').value.trim();
  const cat   = document.getElementById('prodCat').value;
  const offer = document.getElementById('prodOffer').checked;
  const promo = document.getElementById('prodPromo').value.trim();
  const file  = document.getElementById('prodImage').files[0];

  if(!code || !name || !price || !file){ alert('Completa código, nombre, precio e imagen'); return; }
  if(offer && !promo){ if(!confirm('Marcaste OFERTA sin precio promo. ¿Continuar?')) return; }

  const fd = new FormData();
  fd.append('codigo', code);
  fd.append('nombre', name);
  fd.append('precio', price);
  fd.append('categoria', cat);
  fd.append('oferta', offer ? 'true' : 'false');
  fd.append('precioPromo', promo);
  fd.append('imagen', file);

  const r = await fetch(`/upload/${current}`, { method:'POST', body: fd, headers: adminHeader() });
  if(r.ok){
    document.getElementById('prodCode').value='';
    document.getElementById('prodName').value='';
    document.getElementById('prodPrice').value='';
    document.getElementById('prodImage').value='';
    document.getElementById('prodPromo').value='';
    document.getElementById('prodOffer').checked=false;
    currentCat = 'todos';
    document.querySelectorAll('.cat-tab').forEach(b=>b.classList.toggle('active', b.dataset.cat===currentCat));
    renderBranch();
  }else{
    alert('No se pudo subir. ' + (await r.text()));
  }
});

/* === EDITAR / ELIMINAR === */
const editModal = document.getElementById('editModal');
const editCode  = document.getElementById('editCode');
const editName  = document.getElementById('editName');
const editPrice = document.getElementById('editPrice');
const editCat   = document.getElementById('editCat');
const editImage = document.getElementById('editImage');
const editCancel= document.getElementById('editCancel');
const editSave  = document.getElementById('editSave');
const editOffer = document.getElementById('editOffer');
const editPromo = document.getElementById('editPromo');
let editingId = null;

function openEdit(p){
  if(!isAdmin()){ alert('Solo administrador'); return; }
  editingId = p.id;
  editCode.value = p.codigo || '';
  editName.value = p.nombre || '';
  editPrice.value = p.precio || '';
  editCat.value = p.categoria || 'dama';
  editOffer.checked = !!p.oferta;
  editPromo.value = p.precioPromo || '';
  editImage.value = '';
  editModal.style.display = 'flex';
}
editCancel.onclick = ()=>{ editModal.style.display='none'; editingId=null; };

editSave.onclick = async ()=>{
  if(!editingId) return;
  const fd = new FormData();
  if(editCode.value.trim())  fd.append('codigo',   editCode.value.trim());
  if(editName.value.trim())  fd.append('nombre',   editName.value.trim());
  if(editPrice.value.trim()) fd.append('precio',   editPrice.value.trim());
  if(editCat.value)          fd.append('categoria', editCat.value);
  fd.append('oferta', editOffer.checked ? 'true' : 'false');
  fd.append('precioPromo', editPromo.value.trim());
  if(editImage.files[0])     fd.append('imagen',   editImage.files[0]);

  const r = await fetch(`/producto/${current}/${editingId}`, { method:'PUT', body: fd, headers: adminHeader() });
  if(r.ok){
    editModal.style.display = 'none';
    currentCat = 'todos';
    document.querySelectorAll('.cat-tab').forEach(b=>b.classList.toggle('active', b.dataset.cat===currentCat));
    renderBranch();
  }else{
    alert('No se pudo editar. ' + (await r.text()));
  }
};

async function delProduct(p){
  if(!isAdmin()){ alert('Solo administrador'); return; }
  if(!confirm(`Eliminar "${p.nombre}" (código: ${p.codigo || '-'})?`)) return;
  const r = await fetch(`/producto/${current}/${p.id}`, { method:'DELETE', headers: adminHeader() });
  if(r.ok){ renderBranch(); } else { alert('No se pudo eliminar. ' + (await r.text())); }
}

// Init
document.getElementById('year').textContent = new Date().getFullYear();
updateFavCounter();
renderBranch();
</script>
</body>
</html>
